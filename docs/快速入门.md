# ThingsBoard IoT Gateway å¿«é€Ÿå…¥é—¨

æœ¬æŒ‡å—å¸®åŠ©æ‚¨å¿«é€Ÿä¸Šæ‰‹ThingsBoard IoT Gatewayï¼Œä»å®‰è£…åˆ°è¿è¡Œç¬¬ä¸€ä¸ªè¿æ¥å™¨ã€‚

## å‰ç½®è¦æ±‚

- Python 3.10 æˆ–æ›´é«˜ç‰ˆæœ¬
- pip åŒ…ç®¡ç†å™¨
- ThingsBoardå¹³å°è®¿é—®æƒé™ï¼ˆæœ¬åœ°æˆ–äº‘ç«¯ï¼‰
- åŸºæœ¬çš„Pythonå’ŒJSONçŸ¥è¯†

## ç¬¬ä¸€æ­¥ï¼šå®‰è£…

### æ–¹å¼1: ä½¿ç”¨pipå®‰è£…ï¼ˆæ¨èï¼‰

```bash
# å®‰è£…ç½‘å…³
pip install thingsboard-gateway

# éªŒè¯å®‰è£…
thingsboard-gateway --version
```

### æ–¹å¼2: ä½¿ç”¨Docker

```bash
# æ‹‰å–é•œåƒ
docker pull thingsboard/tb-gateway

# è¿è¡Œå®¹å™¨
docker run -it -v ~/.tb-gateway/logs:/thingsboard_gateway/logs \
  -v ~/.tb-gateway/extensions:/thingsboard_gateway/extensions \
  -v ~/.tb-gateway/config:/thingsboard_gateway/config \
  --name tb-gateway --restart always thingsboard/tb-gateway
```

### æ–¹å¼3: ä»æºç å®‰è£…

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/thingsboard/thingsboard-gateway.git
cd thingsboard-gateway

# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# å¼€å‘æ¨¡å¼å®‰è£…
pip install -e .
```

## ç¬¬äºŒæ­¥ï¼šè·å–ThingsBoardè®¿é—®ä»¤ç‰Œ

### åœ¨ThingsBoardå¹³å°åˆ›å»ºç½‘å…³è®¾å¤‡

1. ç™»å½•ThingsBoardå¹³å°
2. è¿›å…¥ **è®¾å¤‡** â†’ **æ·»åŠ è®¾å¤‡**
3. è®¾å¤‡ç±»å‹é€‰æ‹© **Gateway**
4. è¾“å…¥è®¾å¤‡åç§°ï¼Œå¦‚ "My Gateway"
5. ä¿å­˜åï¼Œç‚¹å‡»è®¾å¤‡æŸ¥çœ‹è¯¦æƒ…
6. å¤åˆ¶ **è®¿é—®ä»¤ç‰Œ**ï¼ˆAccess Tokenï¼‰

## ç¬¬ä¸‰æ­¥ï¼šé…ç½®ç½‘å…³

### åˆ›å»ºé…ç½®ç›®å½•

```bash
# Linux/Mac
mkdir -p ~/.tb-gateway/config
cd ~/.tb-gateway/config

# Windows
mkdir %USERPROFILE%\.tb-gateway\config
cd %USERPROFILE%\.tb-gateway\config
```

### åˆ›å»ºä¸»é…ç½®æ–‡ä»¶ tb_gateway.json

```json
{
  "thingsboard": {
    "host": "localhost",
    "port": 1883,
    "security": {
      "type": "accessToken",
      "accessToken": "YOUR_ACCESS_TOKEN_HERE"
    },
    "qos": 1,
    "remoteConfiguration": true,
    "statistics": {
      "enable": true,
      "statsSendPeriodInSeconds": 60
    }
  },
  "storage": {
    "type": "memory",
    "read_records_count": 100,
    "max_records_count": 100000
  },
  "grpc": {
    "enabled": false
  },
  "connectors": []
}
```

**é‡è¦**: å°† `YOUR_ACCESS_TOKEN_HERE` æ›¿æ¢ä¸ºæ‚¨çš„å®é™…è®¿é—®ä»¤ç‰Œã€‚

### åˆ›å»ºæ—¥å¿—é…ç½®æ–‡ä»¶ logs.json

```json
{
  "version": 1,
  "disable_existing_loggers": false,
  "formatters": {
    "LogFormatter": {
      "format": "%(asctime)s - %(levelname)s - [%(filename)s] - %(module)s - %(lineno)d - %(message)s",
      "datefmt": "%Y-%m-%d %H:%M:%S"
    }
  },
  "handlers": {
    "consoleHandler": {
      "class": "logging.StreamHandler",
      "formatter": "LogFormatter",
      "level": "INFO",
      "stream": "ext://sys.stdout"
    }
  },
  "loggers": {
    "service": {
      "level": "INFO",
      "handlers": ["consoleHandler"],
      "propagate": false
    },
    "connector": {
      "level": "INFO",
      "handlers": ["consoleHandler"],
      "propagate": false
    }
  }
}
```

## ç¬¬å››æ­¥ï¼šè¿è¡Œç½‘å…³

```bash
# è®¾ç½®é…ç½®ç›®å½•ç¯å¢ƒå˜é‡
export TB_GW_CONFIG_DIR=~/.tb-gateway/config/

# è¿è¡Œç½‘å…³
thingsboard-gateway
```

æ‚¨åº”è¯¥çœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹çš„è¾“å‡ºï¼š

```
2025-10-08 10:00:00 - INFO - Gateway core started.
2025-10-08 10:00:01 - INFO - Connected to ThingsBoard
```

## ç¬¬äº”æ­¥ï¼šé…ç½®ç¬¬ä¸€ä¸ªè¿æ¥å™¨ï¼ˆMQTTç¤ºä¾‹ï¼‰

### 1. åˆ›å»ºMQTTè¿æ¥å™¨é…ç½®æ–‡ä»¶ mqtt.json

```json
{
  "broker": {
    "name": "Local MQTT Broker",
    "host": "localhost",
    "port": 1883,
    "clientId": "ThingsBoard_gateway",
    "security": {
      "type": "anonymous"
    }
  },
  "mapping": [
    {
      "topicFilter": "sensor/+/data",
      "converter": {
        "type": "json",
        "deviceNameJsonExpression": "${deviceName}",
        "deviceTypeJsonExpression": "Sensor",
        "timeout": 60000,
        "attributes": [],
        "timeseries": [
          {
            "key": "temperature",
            "type": "double",
            "value": "${temperature}"
          },
          {
            "key": "humidity",
            "type": "double",
            "value": "${humidity}"
          }
        ]
      }
    }
  ],
  "connectRequests": [],
  "disconnectRequests": [],
  "attributeRequests": [],
  "attributeUpdates": [],
  "serverSideRpc": []
}
```

### 2. æ›´æ–°ä¸»é…ç½®æ–‡ä»¶

åœ¨ `tb_gateway.json` çš„ `connectors` æ•°ç»„ä¸­æ·»åŠ ï¼š

```json
{
  "connectors": [
    {
      "name": "MQTT Broker Connector",
      "type": "mqtt",
      "configuration": "mqtt.json"
    }
  ]
}
```

### 3. é‡å¯ç½‘å…³

åœæ­¢ç½‘å…³ï¼ˆCtrl+Cï¼‰ï¼Œç„¶åé‡æ–°å¯åŠ¨ï¼š

```bash
thingsboard-gateway
```

## ç¬¬å…­æ­¥ï¼šæµ‹è¯•æ•°æ®å‘é€

### å®‰è£…MQTTå®¢æˆ·ç«¯å·¥å…·

```bash
pip install paho-mqtt
```

### å‘é€æµ‹è¯•æ•°æ®

åˆ›å»ºæµ‹è¯•è„šæœ¬ `test_mqtt.py`:

```python
import paho.mqtt.client as mqtt
import json
import time

# è¿æ¥åˆ°MQTT Broker
client = mqtt.Client()
client.connect("localhost", 1883, 60)

# å‘é€æµ‹è¯•æ•°æ®
while True:
    data = {
        "deviceName": "Sensor001",
        "temperature": 25.5,
        "humidity": 60.0
    }
    
    client.publish("sensor/Sensor001/data", json.dumps(data))
    print(f"Sent: {data}")
    
    time.sleep(5)
```

è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š

```bash
python test_mqtt.py
```

### åœ¨ThingsBoardæŸ¥çœ‹æ•°æ®

1. ç™»å½•ThingsBoardå¹³å°
2. è¿›å…¥ **è®¾å¤‡** é¡µé¢
3. æ‚¨åº”è¯¥çœ‹åˆ°æ–°è®¾å¤‡ "Sensor001"
4. ç‚¹å‡»è®¾å¤‡æŸ¥çœ‹é¥æµ‹æ•°æ®
5. åº”è¯¥èƒ½çœ‹åˆ° temperature å’Œ humidity æ•°æ®

## å¸¸è§é—®é¢˜

### 1. è¿æ¥ThingsBoardå¤±è´¥

**é—®é¢˜**: `Connection refused` æˆ– `Connection timeout`

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ThingsBoardæœåŠ¡æ˜¯å¦è¿è¡Œ
- éªŒè¯hostå’Œporté…ç½®æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥è®¿é—®ä»¤ç‰Œæ˜¯å¦æœ‰æ•ˆ
- æ£€æŸ¥é˜²ç«å¢™è®¾ç½®

### 2. æ‰¾ä¸åˆ°é…ç½®æ–‡ä»¶

**é—®é¢˜**: `Config file not found`

**è§£å†³æ–¹æ¡ˆ**:
```bash
# è®¾ç½®é…ç½®ç›®å½•
export TB_GW_CONFIG_DIR=/path/to/your/config/

# æˆ–è€…ä½¿ç”¨ç»å¯¹è·¯å¾„è¿è¡Œ
thingsboard-gateway /path/to/tb_gateway.json
```

### 3. MQTTè¿æ¥å™¨æ— æ³•è¿æ¥

**é—®é¢˜**: `Failed to connect to MQTT broker`

**è§£å†³æ–¹æ¡ˆ**:
- ç¡®ä¿MQTT Brokeræ­£åœ¨è¿è¡Œ
- æ£€æŸ¥hostå’Œporté…ç½®
- éªŒè¯è®¤è¯ä¿¡æ¯ï¼ˆå¦‚æœéœ€è¦ï¼‰

### 4. è®¾å¤‡æœªå‡ºç°åœ¨ThingsBoard

**é—®é¢˜**: æ•°æ®å‘é€äº†ä½†è®¾å¤‡æœªåˆ›å»º

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ç½‘å…³æ—¥å¿—ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯
- éªŒè¯MQTTä¸»é¢˜è¿‡æ»¤å™¨æ˜¯å¦åŒ¹é…
- æ£€æŸ¥JSONè¡¨è¾¾å¼æ˜¯å¦æ­£ç¡®
- ç¡®ä¿è®¾å¤‡åç§°æå–æ­£ç¡®

## ä¸‹ä¸€æ­¥

### å­¦ä¹ æ›´å¤šè¿æ¥å™¨

- [Modbusè¿æ¥å™¨](https://thingsboard.io/docs/iot-gateway/config/modbus/)
- [OPC-UAè¿æ¥å™¨](https://thingsboard.io/docs/iot-gateway/config/opc-ua/)
- [RESTè¿æ¥å™¨](https://thingsboard.io/docs/iot-gateway/config/rest/)

### æ·±å…¥äº†è§£

- é˜…è¯» [æ¶æ„è®¾è®¡](02-architecture.md)
- å­¦ä¹  [è¿æ¥å™¨ç³»ç»Ÿ](04-connectors.md)
- æŒæ¡ [æ•°æ®è½¬æ¢å™¨](05-converters.md)

### å¼€å‘è‡ªå®šä¹‰åŠŸèƒ½

- é˜…è¯» [å¼€å‘æŒ‡å—](08-development-guide.md)
- æŸ¥çœ‹ [APIå‚è€ƒ](09-api-reference.md)

## å®Œæ•´ç¤ºä¾‹ï¼šModbusè¿æ¥å™¨

### 1. åˆ›å»º modbus.json

```json
{
  "server": {
    "name": "Modbus Server",
    "type": "tcp",
    "host": "192.168.1.100",
    "port": 502,
    "timeout": 35,
    "method": "socket",
    "byteOrder": "BIG",
    "wordOrder": "BIG"
  },
  "devices": [
    {
      "unitId": 1,
      "deviceName": "Temperature Sensor",
      "deviceType": "Sensor",
      "pollPeriod": 5000,
      "sendDataOnlyOnChange": false,
      "attributes": [
        {
          "tag": "model",
          "type": "string",
          "functionCode": 3,
          "objectsCount": 8,
          "address": 0
        }
      ],
      "timeseries": [
        {
          "tag": "temperature",
          "type": "16int",
          "functionCode": 4,
          "objectsCount": 1,
          "address": 0,
          "multiplier": 0.1
        }
      ]
    }
  ]
}
```

### 2. æ·»åŠ åˆ°ä¸»é…ç½®

```json
{
  "connectors": [
    {
      "name": "Modbus Connector",
      "type": "modbus",
      "configuration": "modbus.json"
    }
  ]
}
```

## ç”Ÿäº§ç¯å¢ƒå»ºè®®

### 1. ä½¿ç”¨SQLiteå­˜å‚¨

```json
{
  "storage": {
    "type": "sqlite",
    "data_file_path": "/var/lib/thingsboard-gateway/storage.db",
    "max_records_count": 1000000,
    "read_records_count": 500
  }
}
```

### 2. å¯ç”¨TLSåŠ å¯†

```json
{
  "thingsboard": {
    "host": "thingsboard.cloud",
    "port": 8883,
    "security": {
      "type": "tls",
      "caCert": "/path/to/ca.pem",
      "cert": "/path/to/client.pem",
      "key": "/path/to/client.key"
    }
  }
}
```

### 3. é…ç½®æ—¥å¿—è½®è½¬

```json
{
  "handlers": {
    "fileHandler": {
      "class": "thingsboard_gateway.tb_utility.tb_rotating_file_handler.TimedRotatingFileHandler",
      "formatter": "LogFormatter",
      "filename": "/var/log/tb-gateway/connector.log",
      "when": "D",
      "interval": 1,
      "backupCount": 30
    }
  }
}
```

### 4. ä½œä¸ºç³»ç»ŸæœåŠ¡è¿è¡Œ

åˆ›å»º systemd æœåŠ¡æ–‡ä»¶ `/etc/systemd/system/tb-gateway.service`:

```ini
[Unit]
Description=ThingsBoard IoT Gateway
After=network.target

[Service]
Type=simple
User=tb-gateway
Environment="TB_GW_CONFIG_DIR=/etc/thingsboard-gateway/config/"
ExecStart=/usr/local/bin/thingsboard-gateway
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡ï¼š

```bash
sudo systemctl enable tb-gateway
sudo systemctl start tb-gateway
sudo systemctl status tb-gateway
```

## è·å–å¸®åŠ©

- **å®˜æ–¹æ–‡æ¡£**: https://thingsboard.io/docs/iot-gateway/
- **GitHub Issues**: https://github.com/thingsboard/thingsboard-gateway/issues
- **ç¤¾åŒºè®ºå›**: https://github.com/thingsboard/thingsboard-gateway/discussions
- **StackOverflow**: æ ‡ç­¾ `thingsboard-gateway`

ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼ğŸš€

