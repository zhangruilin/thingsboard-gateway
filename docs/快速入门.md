# ThingsBoard IoT Gateway 快速入门

本指南帮助您快速上手ThingsBoard IoT Gateway，从安装到运行第一个连接器。

## 前置要求

- Python 3.10 或更高版本
- pip 包管理器
- ThingsBoard平台访问权限（本地或云端）
- 基本的Python和JSON知识

## 第一步：安装

### 方式1: 使用pip安装（推荐）

```bash
# 安装网关
pip install thingsboard-gateway

# 验证安装
thingsboard-gateway --version
```

### 方式2: 使用Docker

```bash
# 拉取镜像
docker pull thingsboard/tb-gateway

# 运行容器
docker run -it -v ~/.tb-gateway/logs:/thingsboard_gateway/logs \
  -v ~/.tb-gateway/extensions:/thingsboard_gateway/extensions \
  -v ~/.tb-gateway/config:/thingsboard_gateway/config \
  --name tb-gateway --restart always thingsboard/tb-gateway
```

### 方式3: 从源码安装

```bash
# 克隆仓库
git clone https://github.com/thingsboard/thingsboard-gateway.git
cd thingsboard-gateway

# 安装依赖
pip install -r requirements.txt

# 开发模式安装
pip install -e .
```

## 第二步：获取ThingsBoard访问令牌

### 在ThingsBoard平台创建网关设备

1. 登录ThingsBoard平台
2. 进入 **设备** → **添加设备**
3. 设备类型选择 **Gateway**
4. 输入设备名称，如 "My Gateway"
5. 保存后，点击设备查看详情
6. 复制 **访问令牌**（Access Token）

## 第三步：配置网关

### 创建配置目录

```bash
# Linux/Mac
mkdir -p ~/.tb-gateway/config
cd ~/.tb-gateway/config

# Windows
mkdir %USERPROFILE%\.tb-gateway\config
cd %USERPROFILE%\.tb-gateway\config
```

### 创建主配置文件 tb_gateway.json

```json
{
  "thingsboard": {
    "host": "localhost",
    "port": 1883,
    "security": {
      "type": "accessToken",
      "accessToken": "YOUR_ACCESS_TOKEN_HERE"
    },
    "qos": 1,
    "remoteConfiguration": true,
    "statistics": {
      "enable": true,
      "statsSendPeriodInSeconds": 60
    }
  },
  "storage": {
    "type": "memory",
    "read_records_count": 100,
    "max_records_count": 100000
  },
  "grpc": {
    "enabled": false
  },
  "connectors": []
}
```

**重要**: 将 `YOUR_ACCESS_TOKEN_HERE` 替换为您的实际访问令牌。

### 创建日志配置文件 logs.json

```json
{
  "version": 1,
  "disable_existing_loggers": false,
  "formatters": {
    "LogFormatter": {
      "format": "%(asctime)s - %(levelname)s - [%(filename)s] - %(module)s - %(lineno)d - %(message)s",
      "datefmt": "%Y-%m-%d %H:%M:%S"
    }
  },
  "handlers": {
    "consoleHandler": {
      "class": "logging.StreamHandler",
      "formatter": "LogFormatter",
      "level": "INFO",
      "stream": "ext://sys.stdout"
    }
  },
  "loggers": {
    "service": {
      "level": "INFO",
      "handlers": ["consoleHandler"],
      "propagate": false
    },
    "connector": {
      "level": "INFO",
      "handlers": ["consoleHandler"],
      "propagate": false
    }
  }
}
```

## 第四步：运行网关

```bash
# 设置配置目录环境变量
export TB_GW_CONFIG_DIR=~/.tb-gateway/config/

# 运行网关
thingsboard-gateway
```

您应该看到类似以下的输出：

```
2025-10-08 10:00:00 - INFO - Gateway core started.
2025-10-08 10:00:01 - INFO - Connected to ThingsBoard
```

## 第五步：配置第一个连接器（MQTT示例）

### 1. 创建MQTT连接器配置文件 mqtt.json

```json
{
  "broker": {
    "name": "Local MQTT Broker",
    "host": "localhost",
    "port": 1883,
    "clientId": "ThingsBoard_gateway",
    "security": {
      "type": "anonymous"
    }
  },
  "mapping": [
    {
      "topicFilter": "sensor/+/data",
      "converter": {
        "type": "json",
        "deviceNameJsonExpression": "${deviceName}",
        "deviceTypeJsonExpression": "Sensor",
        "timeout": 60000,
        "attributes": [],
        "timeseries": [
          {
            "key": "temperature",
            "type": "double",
            "value": "${temperature}"
          },
          {
            "key": "humidity",
            "type": "double",
            "value": "${humidity}"
          }
        ]
      }
    }
  ],
  "connectRequests": [],
  "disconnectRequests": [],
  "attributeRequests": [],
  "attributeUpdates": [],
  "serverSideRpc": []
}
```

### 2. 更新主配置文件

在 `tb_gateway.json` 的 `connectors` 数组中添加：

```json
{
  "connectors": [
    {
      "name": "MQTT Broker Connector",
      "type": "mqtt",
      "configuration": "mqtt.json"
    }
  ]
}
```

### 3. 重启网关

停止网关（Ctrl+C），然后重新启动：

```bash
thingsboard-gateway
```

## 第六步：测试数据发送

### 安装MQTT客户端工具

```bash
pip install paho-mqtt
```

### 发送测试数据

创建测试脚本 `test_mqtt.py`:

```python
import paho.mqtt.client as mqtt
import json
import time

# 连接到MQTT Broker
client = mqtt.Client()
client.connect("localhost", 1883, 60)

# 发送测试数据
while True:
    data = {
        "deviceName": "Sensor001",
        "temperature": 25.5,
        "humidity": 60.0
    }
    
    client.publish("sensor/Sensor001/data", json.dumps(data))
    print(f"Sent: {data}")
    
    time.sleep(5)
```

运行测试脚本：

```bash
python test_mqtt.py
```

### 在ThingsBoard查看数据

1. 登录ThingsBoard平台
2. 进入 **设备** 页面
3. 您应该看到新设备 "Sensor001"
4. 点击设备查看遥测数据
5. 应该能看到 temperature 和 humidity 数据

## 常见问题

### 1. 连接ThingsBoard失败

**问题**: `Connection refused` 或 `Connection timeout`

**解决方案**:
- 检查ThingsBoard服务是否运行
- 验证host和port配置是否正确
- 检查访问令牌是否有效
- 检查防火墙设置

### 2. 找不到配置文件

**问题**: `Config file not found`

**解决方案**:
```bash
# 设置配置目录
export TB_GW_CONFIG_DIR=/path/to/your/config/

# 或者使用绝对路径运行
thingsboard-gateway /path/to/tb_gateway.json
```

### 3. MQTT连接器无法连接

**问题**: `Failed to connect to MQTT broker`

**解决方案**:
- 确保MQTT Broker正在运行
- 检查host和port配置
- 验证认证信息（如果需要）

### 4. 设备未出现在ThingsBoard

**问题**: 数据发送了但设备未创建

**解决方案**:
- 检查网关日志，查看是否有错误
- 验证MQTT主题过滤器是否匹配
- 检查JSON表达式是否正确
- 确保设备名称提取正确

## 下一步

### 学习更多连接器

- [Modbus连接器](https://thingsboard.io/docs/iot-gateway/config/modbus/)
- [OPC-UA连接器](https://thingsboard.io/docs/iot-gateway/config/opc-ua/)
- [REST连接器](https://thingsboard.io/docs/iot-gateway/config/rest/)

### 深入了解

- 阅读 [架构设计](02-architecture.md)
- 学习 [连接器系统](04-connectors.md)
- 掌握 [数据转换器](05-converters.md)

### 开发自定义功能

- 阅读 [开发指南](08-development-guide.md)
- 查看 [API参考](09-api-reference.md)

## 完整示例：Modbus连接器

### 1. 创建 modbus.json

```json
{
  "server": {
    "name": "Modbus Server",
    "type": "tcp",
    "host": "192.168.1.100",
    "port": 502,
    "timeout": 35,
    "method": "socket",
    "byteOrder": "BIG",
    "wordOrder": "BIG"
  },
  "devices": [
    {
      "unitId": 1,
      "deviceName": "Temperature Sensor",
      "deviceType": "Sensor",
      "pollPeriod": 5000,
      "sendDataOnlyOnChange": false,
      "attributes": [
        {
          "tag": "model",
          "type": "string",
          "functionCode": 3,
          "objectsCount": 8,
          "address": 0
        }
      ],
      "timeseries": [
        {
          "tag": "temperature",
          "type": "16int",
          "functionCode": 4,
          "objectsCount": 1,
          "address": 0,
          "multiplier": 0.1
        }
      ]
    }
  ]
}
```

### 2. 添加到主配置

```json
{
  "connectors": [
    {
      "name": "Modbus Connector",
      "type": "modbus",
      "configuration": "modbus.json"
    }
  ]
}
```

## 生产环境建议

### 1. 使用SQLite存储

```json
{
  "storage": {
    "type": "sqlite",
    "data_file_path": "/var/lib/thingsboard-gateway/storage.db",
    "max_records_count": 1000000,
    "read_records_count": 500
  }
}
```

### 2. 启用TLS加密

```json
{
  "thingsboard": {
    "host": "thingsboard.cloud",
    "port": 8883,
    "security": {
      "type": "tls",
      "caCert": "/path/to/ca.pem",
      "cert": "/path/to/client.pem",
      "key": "/path/to/client.key"
    }
  }
}
```

### 3. 配置日志轮转

```json
{
  "handlers": {
    "fileHandler": {
      "class": "thingsboard_gateway.tb_utility.tb_rotating_file_handler.TimedRotatingFileHandler",
      "formatter": "LogFormatter",
      "filename": "/var/log/tb-gateway/connector.log",
      "when": "D",
      "interval": 1,
      "backupCount": 30
    }
  }
}
```

### 4. 作为系统服务运行

创建 systemd 服务文件 `/etc/systemd/system/tb-gateway.service`:

```ini
[Unit]
Description=ThingsBoard IoT Gateway
After=network.target

[Service]
Type=simple
User=tb-gateway
Environment="TB_GW_CONFIG_DIR=/etc/thingsboard-gateway/config/"
ExecStart=/usr/local/bin/thingsboard-gateway
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启用并启动服务：

```bash
sudo systemctl enable tb-gateway
sudo systemctl start tb-gateway
sudo systemctl status tb-gateway
```

## 获取帮助

- **官方文档**: https://thingsboard.io/docs/iot-gateway/
- **GitHub Issues**: https://github.com/thingsboard/thingsboard-gateway/issues
- **社区论坛**: https://github.com/thingsboard/thingsboard-gateway/discussions
- **StackOverflow**: 标签 `thingsboard-gateway`

祝您使用愉快！🚀

