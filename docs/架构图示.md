# ThingsBoard IoT Gateway 架构图示

本文档使用Mermaid图表展示ThingsBoard IoT Gateway的各种架构视图。

## 1. 整体系统架构

```mermaid
graph TB
    subgraph "设备层"
        D1[PLC设备]
        D2[传感器]
        D3[仪表]
        D4[控制器]
        D5[IoT设备]
    end
    
    subgraph "ThingsBoard IoT Gateway"
        subgraph "连接器层"
            C1[MQTT Connector]
            C2[Modbus Connector]
            C3[OPC-UA Connector]
            C4[BACnet Connector]
            C5[其他 Connectors]
        end
        
        subgraph "转换器层"
            CV1[Uplink Converters]
            CV2[Downlink Converters]
        end
        
        subgraph "核心服务层"
            GW[TBGatewayService]
            ST[Storage]
            STAT[Statistics]
        end
        
        subgraph "通信层"
            TB[TBClient MQTT]
        end
    end
    
    subgraph "ThingsBoard平台"
        CLOUD[ThingsBoard Cloud/Server]
    end
    
    D1 -->|Modbus| C2
    D2 -->|MQTT| C1
    D3 -->|OPC-UA| C3
    D4 -->|BACnet| C4
    D5 -->|各种协议| C5
    
    C1 --> CV1
    C2 --> CV1
    C3 --> CV1
    C4 --> CV1
    C5 --> CV1
    
    CV1 --> GW
    GW --> ST
    GW --> STAT
    ST --> TB
    
    TB <-->|MQTT| CLOUD
    
    CLOUD -->|RPC/属性更新| TB
    TB --> GW
    GW --> CV2
    CV2 --> C1
    CV2 --> C2
    CV2 --> C3
    CV2 --> C4
    CV2 --> C5
```

## 2. 数据流程图

### 上行数据流（设备→平台）

```mermaid
sequenceDiagram
    participant Device as 设备
    participant Connector as 连接器
    participant Converter as 上行转换器
    participant Gateway as 网关服务
    participant Storage as 存储
    participant TBClient as MQTT客户端
    participant ThingsBoard as ThingsBoard平台
    
    Device->>Connector: 1. 发送原始数据
    Connector->>Converter: 2. 转换数据
    Converter->>Converter: 3. 解析并转换格式
    Converter-->>Connector: 4. 返回ConvertedData
    Connector->>Gateway: 5. send_to_storage()
    Gateway->>Gateway: 6. 添加设备（如需要）
    Gateway->>Storage: 7. 存储数据
    Storage->>Storage: 8. 批量累积
    Storage->>TBClient: 9. 批量读取
    TBClient->>ThingsBoard: 10. MQTT发送
    ThingsBoard-->>TBClient: 11. ACK确认
    TBClient->>Storage: 12. 确认处理完成
    Storage->>Storage: 13. 删除已发送数据
```

### 下行数据流（平台→设备）

```mermaid
sequenceDiagram
    participant ThingsBoard as ThingsBoard平台
    participant TBClient as MQTT客户端
    participant Gateway as 网关服务
    participant Converter as 下行转换器
    participant Connector as 连接器
    participant Device as 设备
    
    ThingsBoard->>TBClient: 1. RPC请求/属性更新
    TBClient->>Gateway: 2. 回调处理
    Gateway->>Gateway: 3. 查找设备连接器
    Gateway->>Connector: 4. on_attributes_update() 或 server_side_rpc_handler()
    Connector->>Converter: 5. 转换命令
    Converter->>Converter: 6. 转换为设备格式
    Converter-->>Connector: 7. 返回设备命令
    Connector->>Device: 8. 发送命令
    Device-->>Connector: 9. 返回结果
    Connector->>Converter: 10. 转换响应
    Converter-->>Connector: 11. 返回ConvertedData
    Connector->>Gateway: 12. send_to_storage()
    Gateway->>TBClient: 13. 发送响应
    TBClient->>ThingsBoard: 14. MQTT发送
```

## 3. 类图

### 核心类关系

```mermaid
classDiagram
    class TBGatewayService {
        -__config: dict
        -tb_client: TBClient
        -__storage: EventStorage
        -__connectors: List~Connector~
        +send_to_storage(name, id, data)
        +add_device(name, content, type)
        +del_device(name)
        +load_connectors()
    }
    
    class TBClient {
        -client: TBGatewayMqttClient
        -__config: dict
        +connect()
        +disconnect()
        +gw_send_telemetry(device, data)
        +gw_send_attributes(device, data)
        +gw_connect_device(device, type)
    }
    
    class Connector {
        <<abstract>>
        +open()*
        +close()*
        +get_name()*
        +is_connected()*
        +on_attributes_update(content)*
        +server_side_rpc_handler(content)*
    }
    
    class MqttConnector {
        -__gateway: TBGatewayService
        -__config: dict
        -__client: MQTTClient
        +run()
        +open()
        +close()
    }
    
    class ModbusConnector {
        -__gateway: TBGatewayService
        -__config: dict
        -__servers: List
        +run()
        +open()
        +close()
    }
    
    class Converter {
        <<abstract>>
        +convert(config, data)*
    }
    
    class UplinkConverter {
        +convert(config, data)
    }
    
    class DownlinkConverter {
        +convert(config, data)
    }
    
    class ConvertedData {
        +device_name: str
        +device_type: str
        -__telemetry: List
        -__attributes: dict
        +add_to_telemetry(entry)
        +add_to_attributes(key, value)
    }
    
    class EventStorage {
        <<abstract>>
        +put(data)*
        +get_event_pack()*
        +event_pack_processing_done()*
    }
    
    class SQLiteEventStorage {
        -__db: Database
        +put(data)
        +get_event_pack()
    }
    
    TBGatewayService --> TBClient
    TBGatewayService --> EventStorage
    TBGatewayService --> Connector
    Connector <|-- MqttConnector
    Connector <|-- ModbusConnector
    Connector --> Converter
    Converter <|-- UplinkConverter
    Converter <|-- DownlinkConverter
    Converter --> ConvertedData
    EventStorage <|-- SQLiteEventStorage
```

## 4. 组件交互图

```mermaid
graph LR
    subgraph "连接器组件"
        MQTT[MQTT Connector]
        MODBUS[Modbus Connector]
        OPCUA[OPC-UA Connector]
    end
    
    subgraph "核心组件"
        GW[Gateway Service]
        STORAGE[Storage]
        STATS[Statistics]
    end
    
    subgraph "通信组件"
        CLIENT[TB Client]
    end
    
    subgraph "工具组件"
        LOADER[Module Loader]
        LOGGER[Logger]
        UTIL[Utility]
    end
    
    MQTT --> GW
    MODBUS --> GW
    OPCUA --> GW
    
    GW --> STORAGE
    GW --> STATS
    GW --> CLIENT
    
    GW --> LOADER
    GW --> LOGGER
    GW --> UTIL
    
    MQTT --> LOGGER
    MODBUS --> LOGGER
    OPCUA --> LOGGER
```

## 5. 线程模型

```mermaid
graph TB
    MAIN[Main Thread]
    
    MAIN --> GW[Gateway Service Thread]
    MAIN --> TB[TB Client Thread]
    MAIN --> ST[Storage Thread]
    MAIN --> STAT[Statistics Thread]
    MAIN --> C1[MQTT Connector Thread]
    MAIN --> C2[Modbus Connector Thread]
    MAIN --> C3[OPC-UA Connector Thread]
    MAIN --> CN[... Other Connectors]
    MAIN --> ASYNC[Async Actions Thread]
    
    C2 --> LOOP1[AsyncIO Event Loop]
    C3 --> LOOP2[AsyncIO Event Loop]
```

## 6. 存储系统架构

```mermaid
graph TB
    subgraph "存储接口"
        ES[EventStorage Abstract]
    end
    
    subgraph "存储实现"
        MEM[MemoryEventStorage]
        FILE[FileEventStorage]
        SQLITE[SQLiteEventStorage]
    end
    
    subgraph "数据结构"
        CD[ConvertedData]
        DEP[DeviceEventPack]
        TE[TelemetryEntry]
    end
    
    ES --> MEM
    ES --> FILE
    ES --> SQLITE
    
    CD --> ES
    ES --> DEP
    DEP --> TE
    
    MEM -.->|内存| RAM[(RAM)]
    FILE -.->|文件| DISK[(Disk Files)]
    SQLITE -.->|数据库| DB[(SQLite DB)]
```

## 7. 配置管理架构

```mermaid
graph TB
    subgraph "配置源"
        LOCAL[本地配置文件]
        ENV[环境变量]
        REMOTE[远程配置ThingsBoard]
    end
    
    subgraph "配置加载"
        LOADER[Config Loader]
        VALIDATOR[Config Validator]
    end
    
    subgraph "配置应用"
        GW[Gateway Service]
        CONN[Connectors]
        CONV[Converters]
    end
    
    LOCAL --> LOADER
    ENV --> LOADER
    REMOTE --> LOADER
    
    LOADER --> VALIDATOR
    VALIDATOR --> GW
    GW --> CONN
    GW --> CONV
    
    REMOTE -.->|热更新| GW
```

## 8. 连接器生命周期

```mermaid
stateDiagram-v2
    [*] --> Created: 创建实例
    Created --> Configured: 加载配置
    Configured --> Opening: open()
    Opening --> Connected: 连接成功
    Opening --> Error: 连接失败
    Error --> Opening: 重试
    Connected --> Running: start()
    Running --> Running: 数据采集循环
    Running --> Disconnected: 连接断开
    Disconnected --> Opening: 自动重连
    Running --> Closing: close()
    Closing --> Stopped: 清理资源
    Stopped --> [*]
```

## 9. 数据转换流程

```mermaid
flowchart TD
    START([开始]) --> READ[读取原始数据]
    READ --> PARSE[解析数据格式]
    PARSE --> EXTRACT[提取设备信息]
    EXTRACT --> CREATE[创建ConvertedData]
    CREATE --> TS{有遥测数据?}
    TS -->|是| ADDTS[添加遥测数据]
    TS -->|否| ATTR{有属性数据?}
    ADDTS --> ATTR
    ATTR -->|是| ADDATTR[添加属性数据]
    ATTR -->|否| VALIDATE
    ADDATTR --> VALIDATE[验证数据]
    VALIDATE --> VALID{数据有效?}
    VALID -->|是| RETURN[返回ConvertedData]
    VALID -->|否| ERROR[记录错误]
    ERROR --> NULL[返回None]
    RETURN --> END([结束])
    NULL --> END
```

## 10. 部署架构

```mermaid
graph TB
    subgraph "边缘设备"
        subgraph "Gateway Container/Process"
            GW[Gateway Service]
            CONN[Connectors]
            STORAGE[Local Storage]
        end
        
        DEV1[设备1]
        DEV2[设备2]
        DEV3[设备3]
    end
    
    subgraph "网络"
        NET[Internet/LAN]
    end
    
    subgraph "云平台"
        TB[ThingsBoard Server]
        DB[(Database)]
        RULE[Rule Engine]
    end
    
    DEV1 --> CONN
    DEV2 --> CONN
    DEV3 --> CONN
    
    CONN --> GW
    GW --> STORAGE
    
    GW <-->|MQTT/TLS| NET
    NET <-->|MQTT/TLS| TB
    
    TB --> DB
    TB --> RULE
```

## 使用说明

这些图表可以帮助您：

1. **理解整体架构**: 查看系统架构图了解各层次关系
2. **追踪数据流**: 通过序列图了解数据如何在系统中流动
3. **学习类设计**: 类图展示了核心类的结构和关系
4. **掌握线程模型**: 了解多线程如何协同工作
5. **理解状态转换**: 状态图展示连接器的生命周期

建议结合源代码和这些图表一起学习，可以更快地掌握项目架构。

